"use strict";

function wrapper(my) {
    function response(socket, start) {
        var diff = process.hrtime(start), nanosecond = 1e9 * diff[0] + diff[1], bytes = socket.bytesWritten - ~~socket.transferRateBytesWritten, data = bytes * __byte / __denominator;
        return socket.transferRateBytesWritten = socket.bytesWritten, (data / (nanosecond / __time)).toFixed(2) + __out;
    }
    function request(socket, start) {
        var diff = process.hrtime(start), nanosecond = 1e9 * diff[0] + diff[1], bytes = socket.bytesRead - ~~socket.transferRateBytesRead, data = bytes * __byte / __denominator;
        return socket.transferRateBytesRead = socket.bytesRead, (data / (nanosecond / __time)).toFixed(2) + __out;
    }
    var finished = require("on-finished"), __denominator = my.denominator, __byte = my.byte, __time = my.time, __out = my.out;
    return my.response ? function(req, res, start) {
        if (!req || "object" != typeof req) throw new TypeError("req required");
        if (!res || "object" != typeof res) throw new TypeError("res required");
        if (!start || Array.isArray(start) === !1) throw new TypeError("start required");
        if (finished.isFinished(res)) {
            var socket = res.socket || req.socket, data = response(socket, start);
            return req.transferRate = res.transferRate = data, data;
        }
        finished(res, function(err, res) {
            if (!err) {
                var socket = res.req.socket, data = response(socket, start);
                req.transferRate = res.transferRate = data;
            }
        });
    } : function(req, res, start) {
        if (!req || "object" != typeof req) throw new TypeError("req required");
        if (!res || "object" != typeof res) throw new TypeError("res required");
        if (!start || Array.isArray(start) === !1) throw new TypeError("start required");
        if (finished.isFinished(req)) {
            var socket = req.socket, data = request(socket, start);
            return req.transferRate = res.transferRate = data, data;
        }
        finished(req, function(err, req) {
            if (!err) {
                var socket = req.socket, data = request(socket, start);
                req.transferRate = res.transferRate = data;
            }
        });
    };
}

function transfer(opt) {
    var options = opt || Object.create(null), my = {
        denominator: 1024,
        byte: 1,
        out: " KB/s",
        time: 1e9,
        response: !0
    };
    return "Byte" === options.data ? (my.denominator = 1, my.byte = 1, my.out = " Byte") : "KB" === options.data ? (my.denominator = 1024, 
    my.byte = 1, my.out = " KB") : "MB" === options.data ? (my.denominator = 1048576, 
    my.byte = 1, my.out = " MB") : "bit" === options.data ? (my.denominator = 1, my.byte = 8, 
    my.out = " bit") : "Kb" === options.data ? (my.denominator = 1e3, my.byte = 8, my.out = " Kbit") : "Mb" === options.data && (my.denominator = 1e6, 
    my.byte = 8, my.out = " Mbit"), "nanosecond" === options.time ? (my.time = 1, my.out += "/ns") : "millisecond" === options.time ? (my.time = 1e6, 
    my.out += "/ms") : "second" === options.time && (my.time = 1e9, my.out += "/s"), 
    options.output === !1 && (my.out = ""), options.response === !1 && (my.response = !1), 
    wrapper(my);
}

module.exports = transfer;
